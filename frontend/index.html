<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UV Index Aggregator</title>
  <script src="https://unpkg.com/htmx.org@2.0.3"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    label { display:block; font-size: 12px; color:#333; }
    input, select, button { padding:8px 10px; font-size:14px; }
    #chart { width: 100%; max-width: 1000px; height: 460px; }
    #result { display: block; }
    .meta { margin-top: 10px; color:#555; }
    .card { border:1px solid #ddd; padding:12px; border-radius:10px; margin-top: 10px; max-width: 1000px; }
    .k { color:#333; font-weight:600; }
    ul { margin: 6px 0 0 18px; }
    code { background:#fafafa; padding:1px 4px; border:1px solid #eee; border-radius:4px; }
  </style>
</head>
<body>
  <h1>UV Index Aggregator</h1>
  <div class="row">
    <div><label>Latitude</label><input id="lat" type="number" step="0.0001" value="37.1882"></div>
    <div><label>Longitude</label><input id="lon" type="number" step="0.0001" value="-3.6067"></div>
    <div><label>Date (YYYY-MM-DD)</label><input id="date" type="text" value=""></div>
    <div><label>Timezone</label><input id="tz" type="text" value="Europe/Madrid" placeholder="auto or IANA zone"></div>
    <div><button id="go" type="button" role="button">Fetch UV Data</button></div>
  </div>

  <div id="result">
    <div id="chart"></div>
    <div id="summary" class="card"></div>
    <div id="providers" class="card"></div>
  </div>

  <script>
    function fetchData() {
      const lat = document.getElementById('lat').value;
      const lon = document.getElementById('lon').value;
      const date = document.getElementById('date').value;
      const tz = document.getElementById('tz').value; // 'auto' or explicit IANA zone
      const qs = new URLSearchParams({ lat, lon });
      if (date) qs.set('date', date);
      if (tz) qs.set('tz', tz);
      fetch('http://localhost:8080/uv?' + qs.toString())
        .then(r => r.json())
        .then(draw)
        .catch(err => alert('Error: ' + err));
    }

    function fmtTime(s) {
      if (!s) return '';
      // Display YYYY-MM-DD HH:MM
      const t = s.replace('T',' ').replace(/:00:00$/, ':00');
      return t.length > 16 ? t.slice(0,16) : t;
    }

    function draw(data) {
      const times = data.hourly.map(h => h.time);
      const consensus = data.hourly.map(h => h.consensus);
      const low = data.hourly.map(h => h.low);
      const high = data.hourly.map(h => h.high);

      const traces = [];

      // Confidence band (filled area)
      traces.push({
        x: times.concat(times.slice().reverse()),
        y: high.concat(low.slice().reverse()),
        name: 'Confidence band',
        fill: 'tozeroy',
        mode: 'lines',
        line: { width: 0 },
        hoverinfo: 'skip',
        opacity: 0.2
      });

      // Consensus line
      traces.push({
        x: times, y: consensus,
        name: 'Consensus (median)',
        mode: 'lines+markers',
        line: { width: 2 },
      });

      // Provider lines
      const providerSet = new Set();
      data.hourly.forEach(h => {
        Object.keys(h.providers || {}).forEach(k => providerSet.add(k));
      });
      providerSet.forEach(name => {
        const y = data.hourly.map(h => (h.providers && h.providers[name] !== undefined) ? h.providers[name] : null);
        traces.push({ x: times, y, name, mode: 'lines', line: { width: 1 } });
      });

      // Outliers as markers
      providerSet.forEach(name => {
        const y = data.hourly.map(h => (h.outliers && h.outliers.includes(name)) ? h.providers[name] : null);
        traces.push({ x: times, y, name: name + ' outlier', mode: 'markers', marker: { size: 6, symbol: 'x' }, showlegend: false });
      });

      const shapes = [];
      if (data.now_bucket_time) {
        shapes.push({
          type: 'line', xref: 'x', yref: 'paper',
          x0: data.now_bucket_time, x1: data.now_bucket_time,
          y0: 0, y1: 1,
          line: { width: 2, dash: 'dot' }
        });
      }

      Plotly.newPlot('chart', traces, {
        title: `UV Index for ${data.date} @ (${data.lat.toFixed(4)}, ${data.lon.toFixed(4)}) [${data.tz}]`,
        yaxis: { title: 'UV Index', rangemode: 'tozero' },
        xaxis: { title: 'Time' },
        margin: { t: 50, r: 20, b: 50, l: 50 },
        shapes
      });

      // Make result container visible after chart is created
      document.getElementById('result').style.display = 'block';

      // Summary card
      const s = data.summary || {};
      const best = (s.windows && s.windows.best) ? s.windows.best : [];
      const moderate = (s.windows && s.windows.moderate) ? s.windows.moderate : [];
      const avoid = (s.windows && s.windows.avoid) ? s.windows.avoid : [];

      function renderIntervals(arr) {
        if (!arr || !arr.length) return '<i>None</i>';
        return '<ul>' + arr.map(w => `<li>${fmtTime(w.start)} → ${fmtTime(w.end)}</li>`).join('') + '</ul>';
      }

      const adviceList = (s.advice || []).map(a => `<li>${a}</li>`).join('');

      document.getElementById('summary').innerHTML = `
        <div><span class="k">Now:</span> ${fmtTime(data.now_local_iso)} (${data.tz})</div>
        <div><span class="k">Peak UV:</span> ${s.uv_max ?? '–'} at ${fmtTime(s.uv_max_time)}</div>
        <div class="k" style="margin-top:6px;">SPF & Sun Safety</div>
        <ul>${adviceList || '<li><i>No advice (no data)</i></li>'}</ul>
        <div class="k" style="margin-top:6px;">Exposure windows</div>
        <div><b>Best</b> (UV < 3): ${renderIntervals(best)}</div>
        <div><b>Moderate</b> (3 ≤ UV < 6): ${renderIntervals(moderate)}</div>
        <div><b>Avoid</b> (UV ≥ 8): ${renderIntervals(avoid)}</div>
      `;

      // Providers meta
      const meta = (data.providers || []).map(p => {
        if (p.error) return `<li><b>${p.name}</b>: <i>${p.error}</i></li>`;
        return `<li><b>${p.name}</b>: OK</li>`;
      }).join('');
      document.getElementById('providers').innerHTML = `
        <div><b>Providers</b></div>
        <ul>${meta}</ul>
        <div class="meta">Tip: leave <code>Timezone</code> as <code>auto</code> for automatic detection based on coordinates.</div>
      `;
    }

    document.getElementById('go').addEventListener('click', fetchData);
  </script>
</body>
</html>