<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="UV Index Aggregator - Get UV index data from multiple weather providers for any location and date to make informed sun exposure decisions." />
  <meta name="theme-color" content="#0d6efd" />
  <link rel="manifest" href="manifest.json" />
  <title>UV Index Aggregator</title>
  <!-- Preload critical resources -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.plot.ly" crossorigin>
  
  <!-- Critical CSS inlined for faster rendering -->
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; color: #212529; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    label { display:block; font-size: 12px; color:#212529; font-weight: 500; }
    input, select, button { padding:8px 10px; font-size:14px; border: 1px solid #ced4da; border-radius: 4px; }
    button { background-color: #0d6efd; color: white; border: none; cursor: pointer; font-weight: 500; }
    button:hover { background-color: #0b5ed7; }
    button:focus { outline: 2px solid #86b7fe; outline-offset: 2px; }
    input:focus { outline: 2px solid #86b7fe; outline-offset: 2px; border-color: #86b7fe; }
    #chart { width: 100%; max-width: 1000px; height: 460px; }
    #result { display: block; }
    .meta { margin-top: 10px; color:#6c757d; }
    .card { border:1px solid #dee2e6; padding:12px; border-radius:10px; margin-top: 10px; max-width: 1000px; }
    .k { color:#212529; font-weight:600; }
    h2 { font-size: 1.25rem; margin: 0 0 12px 0; color: #212529; }
    h3 { font-size: 1.1rem; margin: 12px 0 6px 0; color: #212529; }
    ul { margin: 6px 0 0 18px; }
    code { background:#f8f9fa; padding:1px 4px; border:1px solid #dee2e6; border-radius:4px; color: #e83e8c; }
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: #0d6efd;
      color: white;
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 1000;
    }
    .skip-link:focus {
      top: 6px;
    }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    /* Performance optimizations */
    * {
      box-sizing: border-box;
    }
    img {
      max-width: 100%;
      height: auto;
    }
  </style>
  
  <!-- Load JavaScript asynchronously to prevent render blocking -->
  <script src="https://unpkg.com/htmx.org@2.0.3" async></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" async></script>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <main id="main-content">
    <h1>UV Index Aggregator</h1>
    <form role="search" aria-label="UV data search form">
      <div class="row">
        <div><label for="lat">Latitude</label><input id="lat" name="lat" type="number" step="0.0001" value="37.1882" required aria-describedby="lat-desc"><small id="lat-desc" class="sr-only">Enter latitude coordinate between -90 and 90</small></div>
        <div><label for="lon">Longitude</label><input id="lon" name="lon" type="number" step="0.0001" value="-3.6067" required aria-describedby="lon-desc"><small id="lon-desc" class="sr-only">Enter longitude coordinate between -180 and 180</small></div>
        <div><label for="date">Date (YYYY-MM-DD)</label><input id="date" name="date" type="date" value="" aria-describedby="date-desc"><small id="date-desc" class="sr-only">Select date for UV data</small></div>
        <div><label for="tz">Timezone</label><input id="tz" name="tz" type="text" value="Europe/Madrid" placeholder="auto or IANA zone" aria-describedby="tz-desc"><small id="tz-desc" class="sr-only">Enter timezone or use 'auto' for automatic detection</small></div>
        <div><button id="go" type="submit" aria-describedby="go-desc">Fetch UV Data</button><small id="go-desc" class="sr-only">Submit form to fetch UV data for specified location and date</small></div>
      </div>
    </form>

    <div id="result">
      <div id="chart" role="img" aria-label="UV Index chart showing data over time"></div>
      <div id="summary" class="card" role="region" aria-label="UV Index summary and recommendations"></div>
      <div id="providers" class="card" role="region" aria-label="Data provider information"></div>
    </div>
  </main>

  <script>
    function checkLibs() {
      return typeof Plotly !== 'undefined' && typeof htmx !== 'undefined';
    }

    function waitLibs() {
      return new Promise((resolve) => {
        if (checkLibs()) {
          resolve();
          return;
        }

        const interval = setInterval(() => {
          if (checkLibs()) {
            clearInterval(interval);
            resolve();
          }
        }, 50);

        setTimeout(() => {
          clearInterval(interval);
          resolve();
        }, 5000);
      });
    }

    function getUiSections() {
      const result = document.getElementById('result');
      const chart = document.getElementById('chart');
      const summary = document.getElementById('summary');
      const providers = document.getElementById('providers');
      return { result, chart, summary, providers };
    }

    function showLoadingState() {
      const { result, chart, summary, providers } = getUiSections();
      if (!result || !chart || !summary || !providers) {
        return;
      }

      const loading = document.createElement('div');
      loading.setAttribute('role', 'status');
      loading.setAttribute('aria-live', 'polite');
      loading.setAttribute('aria-label', 'Loading UV data');
      loading.style.cssText =
        'padding:20px;text-align:center;color:#6c757d;font-weight:500;';
      loading.textContent = 'Loading UV data…';

      chart.innerHTML = '';
      chart.appendChild(loading);
      summary.innerHTML = '';
      providers.innerHTML = '';
      result.style.display = 'block';
    }

    function showErrorState(message) {
      const { result, chart, summary, providers } = getUiSections();
      if (!result || !chart || !summary || !providers) {
        return;
      }

      const error = document.createElement('div');
      error.setAttribute('role', 'alert');
      error.setAttribute('aria-live', 'assertive');
      error.style.cssText =
        'color:#dc3545;padding:12px;border:1px solid #f5c6cb;background-color:#f8d7da;border-radius:4px;margin-top:12px;font-weight:500;';
      error.textContent = message;

      chart.innerHTML = '';
      chart.appendChild(error);
      summary.innerHTML = '';
      providers.innerHTML = '';
      result.style.display = 'block';
    }

    function fetchData() {
      const lat = document.getElementById('lat').value;
      const lon = document.getElementById('lon').value;
      const date = document.getElementById('date').value;
      const tz = document.getElementById('tz').value;

      const params = new URLSearchParams({ lat, lon });
      if (date) params.set('date', date);
      if (tz) params.set('tz', tz);

      showLoadingState();

      fetch(`http://localhost:8080/uv?${params.toString()}`)
        .then((response) => response.json())
        .then(draw)
        .catch((err) => {
          console.error('Error fetching UV data', err);
          showErrorState(`Error fetching UV data: ${err}`);
        });
    }

    function fmtTime(s) {
      if (!s) return '';
      const t = s.replace('T', ' ').replace(/:00:00$/, ':00');
      return t.length > 16 ? t.slice(0, 16) : t;
    }

    function buildProviderSet(data) {
      const names = new Set((data.providers || []).map((p) => p.name));
      data.hourly.forEach((h) => {
        Object.keys(h.providers || {}).forEach((key) => names.add(key));
      });
      return names;
    }

    function renderIntervals(arr) {
      if (!arr || !arr.length) return '<i>None</i>';
      return (
        '<ul>' +
        arr
          .map((w) => `<li>${fmtTime(w.start)} → ${fmtTime(w.end)}</li>`)
          .join('') +
        '</ul>'
      );
    }

    async function draw(data) {
      await waitLibs();
      const { result, chart, summary, providers } = getUiSections();

      if (!chart || !summary || !providers || !result) {
        console.error('Missing UI containers for rendering');
        return;
      }

      if (typeof Plotly === 'undefined') {
        console.error('Plotly failed to load');
        showErrorState('Chart library failed to load. Please refresh the page.');
        return;
      }

      const times = data.hourly.map((h) => h.time);
      const consensus = data.hourly.map((h) => h.consensus);
      const low = data.hourly.map((h) => h.low);
      const high = data.hourly.map((h) => h.high);
      const traces = [];

      if (times.length) {
        traces.push({
          x: times.concat(times.slice().reverse()),
          y: high.concat(low.slice().reverse()),
          name: 'Confidence band',
          fill: 'tozeroy',
          mode: 'lines',
          line: { width: 0 },
          hoverinfo: 'skip',
          opacity: 0.2,
        });
      }

      traces.push({
        x: times,
        y: consensus,
        name: 'Consensus (median)',
        mode: 'lines+markers',
        line: { width: 2 },
        marker: { size: 6 },
      });

      const providerSet = buildProviderSet(data);
      providerSet.forEach((name) => {
        const y = data.hourly.map((h) =>
          h.providers && h.providers[name] !== undefined ? h.providers[name] : null,
        );
        traces.push({
          x: times,
          y,
          name,
          mode: 'lines+markers',
          line: { width: 1 },
          marker: { size: 5 },
        });
      });

      providerSet.forEach((name) => {
        const y = data.hourly.map((h) =>
          h.outliers && h.outliers.includes(name) ? h.providers[name] : null,
        );
        traces.push({
          x: times,
          y,
          name: `${name} outlier`,
          mode: 'markers',
          marker: { size: 7, symbol: 'x' },
          showlegend: false,
        });
      });

      const shapes = [];
      if (data.now_bucket_time) {
        shapes.push({
          type: 'line',
          xref: 'x',
          yref: 'paper',
          x0: data.now_bucket_time,
          x1: data.now_bucket_time,
          y0: 0,
          y1: 1,
          line: { width: 2, dash: 'dot' },
        });
      }

      Plotly.react(
        chart,
        traces,
        {
          title: `UV Index for ${data.date} @ (${data.lat.toFixed(4)}, ${data.lon.toFixed(4)}) [${data.tz}]`,
          yaxis: { title: 'UV Index', rangemode: 'tozero' },
          xaxis: { title: 'Time' },
          margin: { t: 50, r: 20, b: 50, l: 50 },
          shapes,
          hovermode: 'x unified',
        },
        { displaylogo: false, responsive: true },
      );

      result.style.display = 'block';

      const summaryData = data.summary || {};
      const best = summaryData.windows && summaryData.windows.best ? summaryData.windows.best : [];
      const moderate =
        summaryData.windows && summaryData.windows.moderate ? summaryData.windows.moderate : [];
      const avoid = summaryData.windows && summaryData.windows.avoid ? summaryData.windows.avoid : [];

      const adviceList = (summaryData.advice || [])
        .map((item) => `<li>${item}</li>`)
        .join('');

      summary.innerHTML = `
        <h2>UV Index Summary</h2>
        <div><span class="k">Now:</span> ${fmtTime(data.now_local_iso)} (${data.tz})</div>
        <div><span class="k">Peak UV:</span> ${summaryData.uv_max ?? '–'} at ${fmtTime(summaryData.uv_max_time)}</div>
        <h3 style="margin-top:12px; margin-bottom:6px;">SPF & Sun Safety</h3>
        <ul>${adviceList || '<li><i>No advice (no data)</i></li>'}</ul>
        <h3 style="margin-top:12px; margin-bottom:6px;">Exposure Windows</h3>
        <div><strong>Best</strong> (UV < 3): ${renderIntervals(best)}</div>
        <div><strong>Moderate</strong> (3 ≤ UV < 6): ${renderIntervals(moderate)}</div>
        <div><strong>Avoid</strong> (UV ≥ 8): ${renderIntervals(avoid)}</div>
      `;

      const meta = (data.providers || [])
        .map((p) => {
          if (p.error) {
            return `<li><b>${p.name}</b>: <i>${p.error}</i></li>`;
          }
          return `<li><b>${p.name}</b>: OK</li>`;
        })
        .join('');

      providers.innerHTML = `
        <h2>Data Providers</h2>
        <ul>${meta}</ul>
        <p class="meta">Tip: leave <code>Timezone</code> as <code>auto</code> for automatic detection based on coordinates.</p>
      `;
    }

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.querySelector('form');
      form.addEventListener('submit', function (event) {
        event.preventDefault();
        fetchData();
      });

      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date').value = today;

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js');
      }
    });
  </script>
</body>
</html>
